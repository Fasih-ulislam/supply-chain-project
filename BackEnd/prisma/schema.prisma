// -----------------------------------------------------
// GENERATOR + DATASOURCE
// -----------------------------------------------------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------
// ENUMS
// -----------------------------------------------------

enum Role {
  ADMIN
  SUPPLIER
  DISTRIBUTOR
  RETAILER
  CUSTOMER
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OrderStatus {
  PENDING // buyer created
  APPROVED // seller approved
  PROCESSING // seller preparing
  IN_TRANSIT // transporter assigned
  DELIVERED // buyer confirmed receipt
  CANCELLED // buyer cancelled or seller rejected
  RETURNED // seller marked as returned
}

// -----------------------------------------------------
// USERS & AUTH
// -----------------------------------------------------

model PendingUser {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String
  password  String
  otp       String
  otpExpiry DateTime
  createdAt DateTime @default(now())
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  picture   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userRoles      UserRole[]
  roleRequests   RoleRequest[]
  products       Product[]
  inventories    Inventory[]
  ordersMade     Order[]         @relation("buyerOrders")
  ordersReceived Order[]         @relation("sellerOrders")
  trackingFrom   TrackingEvent[] @relation("TrackingFromUser")
  trackingTo     TrackingEvent[] @relation("TrackingToUser")
}

// MULTI-ROLE TABLE
model UserRole {
  id     Int  @id @default(autoincrement())
  userId Int
  role   Role

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, role])
}

// ROLE REQUESTS
model RoleRequest {
  id              Int           @id @default(autoincrement())
  userId          Int
  requestedRole   Role
  businessName    String
  businessAddress String
  contactNumber   String
  NTN             String?
  status          RequestStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id])
}

// -----------------------------------------------------
// PRODUCTS
// -----------------------------------------------------

// Only suppliers can create products
model Product {
  id          Int      @id @default(autoincrement())
  name        String
  category    String
  batchNo     String
  qrCode      String?  @unique
  description String?
  price       Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdById Int
  createdBy   User @relation(fields: [createdById], references: [id])

  inventories Inventory[]
  orders      Order[]
}

// -----------------------------------------------------
// INVENTORY
// -----------------------------------------------------

model Inventory {
  id        Int      @id @default(autoincrement())
  userId    Int // owner of the inventory
  productId Int
  role      Role // SUPPLIER, DISTRIBUTOR, or RETAILER
  quantity  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])
  orders  Order[]

  @@unique([userId, productId, role]) // prevents mixing stock
}

// -----------------------------------------------------
// ORDER SYSTEM
// -----------------------------------------------------

model Order {
  id              Int         @id @default(autoincrement())
  orderDate       DateTime    @default(now())
  quantity        Int
  totalAmount     Float
  status          OrderStatus @default(PENDING)
  deliveryAddress String

  // RELATIONS
  productId Int
  product   Product @relation(fields: [productId], references: [id])

  inventoryId Int
  inventory   Inventory @relation(fields: [inventoryId], references: [id])

  buyerId Int
  buyer   User @relation("buyerOrders", fields: [buyerId], references: [id])

  sellerId Int
  seller   User @relation("sellerOrders", fields: [sellerId], references: [id])

  transporterId Int?
  transporter   Transporter? @relation(fields: [transporterId], references: [id])

  trackingEvents TrackingEvent[]
}

// -----------------------------------------------------
// TRANSPORTER
// -----------------------------------------------------
model Transporter {
  id     Int     @id @default(autoincrement())
  name   String
  phone  String
  orders Order[]
}

// -----------------------------------------------------
// TRACKING EVENTS
// -----------------------------------------------------

model TrackingEvent {
  id          Int      @id @default(autoincrement())
  orderId     Int
  fromUserId  Int?
  toUserId    Int?
  status      String // The status at this point (e.g., APPROVED, PROCESSING, etc.)
  description String?
  timestamp   DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id])

  fromUser User? @relation("TrackingFromUser", fields: [fromUserId], references: [id])
  toUser   User? @relation("TrackingToUser", fields: [toUserId], references: [id])
}
